<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../lib/iconfont.css">

    <title> iFruit Cloud Music</title>
</head>

<body>
    <div class="con">
        <div class="front-panel-box" id="frontPanel">

            <div class="front-panel">

                <div class="front-panel-head">
                    <div class="go-back" onclick="goBack()">&lt;返回</div>
                </div>
                <div class="main-area">
                    <div class="main-area-left" id="frontLeft">
                        <img src="../img/350px-Madogatari_Queen.png" alt="" id="frontDiskPic">
                        <div class="disk-info" id="frontDiskInfo">XX首歌曲，XXXXX小时XX分钟</div>
                        <div class="play-bottom-box">
                            <div class="play-bottom">播放</div>
                            <div class="play-bottom">随机播放</div>
                        </div>
                        <div class="description" id="frontDescription">
                            这是测试页面用这是测试页面用这是测试页面用这是测试页面用这是测试页面用这是测试页面用这是测试页面用这是测试页面用</div>
                    </div>
                    <div class="main-area-right">
                        <div class="front-panel-disk-info">
                            <div class="front-panel-disk-name" id="frontPanelDiskName">
                                这是歌单名称允许换行换个行换个行换个行换个行换个行换个行
                            </div>
                            <div class="front-panel-disk-creator" id="frontPanelDiskCreator">
                                作者名字：某人-觉得这么写还不够变态斯基-正在进入炼狱模式
                            </div>
                        </div>
                        <div class="front-panel-song-list" id="frontPanelSongList">
                            <div class="front-panel-song">
                                <div class="song-num">1</div>
                                <div class="song-name">Kimino Shiranai Monogatari</div>
                                <div class="song-artist">supercell</div>
                                <div class="song-length">5:40</div>
                            </div>
                            <div class="front-panel-song">
                                <div class="song-num">2</div>
                                <div class="song-name">Kimino Shiranai Monogatari</div>
                                <div class="song-artist">supercell</div>
                                <div class="song-length">5:40</div>
                            </div>
                            <div class="front-panel-song">
                                <div class="song-num">3</div>
                                <div class="song-name">Kimino Shiranai Monogatari</div>
                                <div class="song-artist">supercell</div>
                                <div class="song-length">5:40</div>
                            </div>
                            <div class="front-panel-song">
                                <div class="song-num">4</div>
                                <div class="song-name">如果你看到这个，说明js没有正确加载</div>
                                <div class="song-artist">AlexZ</div>
                                <div class="song-length">0:00</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fornt-panel-bottom"></div>
            </div>
        </div>
        <!-- ======= -->
        <div class="main-area-box" id="mainAreaBox">
            <div class="top-bar" id="top">
                <div class="left-site">
                    <div class="current-date" id="currentDate">M月D日 EEE</div>
                    <div class="bigest-title">为你推荐</div>
                </div>
                <a class="user-avatar" href="JavaScript:void(0)" onclick="test()">
                    <img src="../img/350px-Madogatari_Queen.png" alt="">
                </a>
            </div>
            <!-- = -->
            <div class="list">
                <div class="list-title">
                    <div class="list-title-text" onclick="fu()">
                        推荐歌单
                    </div>
                    <a class="view-all" href="JavaScript:void(0)">
                        显示全部
                    </a>
                </div>
                <div class="list-items">
                    <div class="left-arrow" id="recommendDiskLArr" onclick="leftRoll('recommendDisk')">&lt;</div>
                    <div class="disk-box" id="recommendDisk">

                    </div>
                    <div class="right-arrow" id="recommendDiskLArr" onclick="rightRoll('recommendDisk')">&gt;</div>
                </div>
            </div>
            <!-- = -->
            <div class="list">
                <div class="list-title">
                    <div class="list-title-text">
                        网友精选碟
                    </div>
                    <a class="view-all" href="JavaScript:void(0)">
                        显示全部
                    </a>
                </div>
                <div class="list-items">
                    <div class="left-arrow" id="hotestDiskLArr" onclick="leftRoll('hotestDisk')">&lt;</div>
                    <div class="disk-box" id="hotestDisk">
                        <!-- Wait for ajax.. -->
                    </div>
                    <div class="right-arrow" id="hotestDiskRArr" onclick="rightRoll('hotestDisk')">&gt;</div>
                </div>
            </div>
            <!-- = -->
            <div class="list">
                <div class="list-title">
                    <div class="list-title-text">
                        新碟上架
                    </div>
                    <a class="view-all" href="JavaScript:void(0)">
                        显示全部
                    </a>
                </div>
                <div class="list-items">
                    <div class="left-arrow" id="newDiskLArr" onclick="leftRoll('newDisk')">&lt;</div>
                    <div class="disk-box" id="newDisk">

                    </div>
                    <div class="right-arrow" id="newDiskRArr" onclick="rightRoll('newDisk')">&gt;</div>
                </div>
            </div>
            <!-- = -->
            <div class="bottom"></div>

            <!-- = -->
            <div class="sub-bar" id="subBar">
                <div class="glass"></div>
                <div class="ctrl-panel">
                    <div class="ctrl-item-box">
                        <div class="ctrl-item">
                            <span class="iconfont icon-AppleMusic my-icon"></span>
                            <div class="ctrl-text">资料库</div>
                        </div>
                    </div>
                    <div class="ctrl-item-box">
                        <div class="ctrl-item">
                            <span class="iconfont icon-aixin my-icon-selected"></span>
                            <div class="ctrl-text-selected">为你推荐</div>
                        </div>
                    </div>
                    <div class="ctrl-item-box">
                        <div class="ctrl-item">
                            <span class="iconfont icon-sousuo  my-icon"></span>
                            <div class="ctrl-text">搜索</div>
                        </div>
                    </div>
                </div>
                <div class="line"></div>
                <div class="player">
                    <audio src="https://music.163.com/song/media/outer/url?id=825646.mp3" id="currentSong"></audio>
                    <img src="../img/AppleMusic.png" alt="" class="current-img" id="currentSongPic">
                    <div class="current-song">
                        <div id="currentSongName">
                            未在播放
                        </div>
                    </div>
                    <div class="play" id="play">
                        <div onclick="play()">
                            <span class="iconfont icon-qiyong tools"></span>
                        </div>
                    </div>
                    <!-- <div onclick="pause()">
                <span class="iconfont icon-zanting tools"></span>
            </div> -->
                    <div class="next-song">
                        <span class="iconfont icon-ai-rew-right tools"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    let currentPlayList = [];
    let currentSongInList = 0;
    let frontNode = document.getElementById("frontPanel");
    let frontDiskPic = document.getElementById("frontDiskPic");
    let frontDiskInfoNode = document.getElementById("frontDiskInfo");
    let frontDescriptionNode = document.getElementById("frontDescription");
    let frontPanelDiskNameNode = document.getElementById("frontPanelDiskName");
    let frontPanelDiskCreatorNode = document.getElementById("frontPanelDiskCreator");
    let frontPanelSongListNode = document.getElementById("frontPanelSongList");
    initPage();

    fetch('http://www.huishiguang.com:3000/top/playlist?limit=16&order=hot', {
            method: "get",
            mode: "cors"
        })
        .then(function (r) {
            return r.json()
        })
        .then(function (data) {
            if (data.code != 200) {
                console.log(data.msg);
            } else {
                let strHtml = "";
                data.playlists.forEach(element => {
                    strHtml += `<div class="disk" onclick="getDiskInfo(${element.id})">
                    <img src="${element.coverImgUrl}" alt="">
                    <div class="disk-name">${element.name}</div>
                </div>`;
                });
                let temp = document.getElementById("hotestDisk");
                temp.style.width = (250 * 16 + 100) + 'px';
                temp.innerHTML = strHtml;
            }
        });
    fetch('http://www.huishiguang.com:3000/album/newest', {
            method: "get",
            mode: "cors"
        })
        .then(function (r) {
            return r.json()
        })
        .then(function (data) {
            if (data.code != 200) {
                console.log(data.msg);
            } else {
                let strHtml = "";
                data.albums.forEach(element => {
                    strHtml += `<div class="disk" onclick="getAlbumInfo(${element.id})">
                    <img src="${element.blurPicUrl}" alt="">
                    <div class="disk-name">${element.name}</div>
                </div>`;
                });
                let temp = document.getElementById("newDisk");
                temp.style.width = (250 * 16 + 100) + 'px';
                temp.innerHTML = strHtml;
            }
        });
    fetch('http://www.huishiguang.com:3000/personalized?limit=16', {
            method: "get",
            mode: "cors"
        })
        .then(function (r) {
            // console.log(r);
            return r.json()
        })
        .then(function (data) {
            let strHtml = "";
            if (data.code != 200) {
                console.log(data.msg);
            } else {
                data.result.forEach(element => {
                    strHtml += `<div class="disk" onclick="getDiskInfo(${element.id})">
                    <img src="${element.picUrl}" alt="">
                    <div class="disk-name">${element.name}</div>
                </div>`;
                });
                let temp = document.getElementById("recommendDisk");
                temp.style.width = (250 * 16 + 100) + 'px';
                temp.innerHTML = strHtml;
            }
        });
    fetch('http://www.huishiguang.com:3000/album?id=81917', {
            method: "get",
            mode: "cors"
        })
        .then(function (r) {
            return r.json()
        }).then(function (data) {
            renderingFrontPage(data.album.picUrl, data.album.description, data.album.name, data.album.artist.name,
                data.songs);
        })

    function renderingFrontPage(picUrl, description, name, artistName, songList) {
        frontDiskPic.src = picUrl;
        frontDescriptionNode.innerHTML = description;
        frontPanelDiskNameNode.innerHTML = name;
        frontPanelDiskCreatorNode.innerHTML = artistName;
        let htmlStr = ``;
        let songCount = 0;
        let totalLength = 0;
        songList.forEach(element => {
            let mins = Math.floor(element.dt / 60000);
            let secs = Math.floor(element.dt / 1000) - 60 * mins;
            songCount++;
            totalLength += element.dt / 1000;
            if (songCount < 101) {
                htmlStr += `<div class="front-panel-song" onclick="changePlaylist('${element.id}','${element.name}','${picUrl}')">
                            <div class="song-num">${songCount}</div>
                            <div class="song-name">${element.name}</div>
                            <div class="song-artist">${element.ar[0].name}</div>
                            <div class="song-length">${mins+":"+secs}</div>
                        </div>`;
            } else if (songCount == 101) {
                htmlStr +=
                    `<div style="color:#858585;font-size:18px;line-height:64px;text-align:right">暂时只显示前100首歌曲</div>`;
            }
        });
        if (Math.floor(totalLength / 60) < 60) {
            frontDiskInfoNode.innerHTML = `${songCount}首歌曲，${Math.floor(totalLength/60)}分钟`;
        } else {
            frontDiskInfoNode.innerHTML =
                `${songCount}首歌曲，${Math.floor(totalLength/360)}小时${Math.floor(totalLength/60)%Math.floor(totalLength/360)}分钟`;
        }
        frontPanelSongListNode.innerHTML = htmlStr;
    }

    function play() { //播放器控件-播放
        console.log("play!");
        let player = document.getElementById("currentSong");
        player.play();
        let node = document.getElementById("play");
        node.innerHTML = `<div onclick="pause()">
                <span class="iconfont icon-zanting tools"></span>
            </div>`;
    }

    function pause() { //播放器控件-暂停
        console.log("pause!");
        let player = document.getElementById("currentSong");
        player.pause();
        let node = document.getElementById("play");
        node.innerHTML = `<div onclick="play()">
                <span class="iconfont icon-qiyong tools"></span>
            </div>`;
    }

    function getDiskInfo(id) { //获取歌单详情信息，直接渲染并转跳
        fetch('http://www.huishiguang.com:3000/playlist/detail?id=' + id, {
                method: "get",
                mode: "cors"
            })
            .then(function (r) {
                return r.json()
            }).then(function (data) {
                renderingFrontPage(data.playlist.coverImgUrl, data.playlist.description, data.playlist.name, data
                    .playlist.creator.nickname, data.playlist.tracks);
                showDetails();
            })
    }

    function getAlbumInfo(id) { //获取专辑的详细信息，直接渲染进上层并转跳
        fetch('http://www.huishiguang.com:3000/album?id=' + id, {
                method: "get",
                mode: "cors"
            })
            .then(function (r) {
                return r.json()
            }).then(function (data) {
                renderingFrontPage(data.album.picUrl, data.album.description, data.album.name, data.album.artist
                    .name, data.songs);
                showDetails();
            })
    }

    function changePlaylist(id, name, pic) {
        let player = document.getElementById("currentSong");
        let nameNode = document.getElementById("currentSongName");
        let picNode = document.getElementById("currentSongPic");
        nameNode.innerHTML = name;
        picNode.src = pic;
        player.src = "https://music.163.com/song/media/outer/url?id=" + id;
        play();

    }

    function goBack() {
        let node = document.getElementById("frontPanel");
        node.style.left = "100%";
    }

    function test() {
        showDetails();
    }

    function showDetails() {
        frontNode.scrollTop = 0;
        let node = document.getElementById("frontPanel");
        node.style.left = "0%";
    }

    function rightRoll(id) {
        let node = document.getElementById(id);
        //获取当前盒
        let boxWidth = document.body.clientWidth * 0.9;
        let fullDisplayCount = Math.floor(boxWidth / 250);
        let originalMarginL = parseInt(window.getComputedStyle(node, null).marginLeft);
        originalMarginL = Math.floor(originalMarginL / 250) * 250;
        if (originalMarginL - boxWidth > node.childElementCount * -250) {
            let marginL = originalMarginL - fullDisplayCount * 250;
            node.style.marginLeft = marginL + 'px';
        }
    }

    function leftRoll(id) {
        let node = document.getElementById(id);
        //获取当前盒
        let boxWidth = document.body.clientWidth * 0.9;
        //先看他移动了多少
        let originalMarginL = parseInt(window.getComputedStyle(node, null).marginLeft);
        originalMarginL = Math.floor(originalMarginL / 250) * 250;
        if (originalMarginL < 0) {
            let marginL = originalMarginL + Math.floor(boxWidth / 250) * 250;
            if (marginL > 0) {
                marginL = 0;
            }
            node.style.marginLeft = marginL + 'px';
        }
    }

    function initPage() {
        let currentDateNode = document.getElementById("currentDate");
        let week=["星期一","星期二","星期三","星期四","星期五","星期六","星期日"];
        let today = new Date();
        currentDateNode.innerHTML=(today.getMonth()+1)+"月"+today.getDate()+"日 "+week[today.getDay()-1];
    }
    
</script>

</html>